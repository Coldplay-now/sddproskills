---
name: task-planner
description: 根据 PRD 和技术 Spec 文档，通过引导式问答帮助用户制定开发计划。分析项目模块依赖，拆解研发任务，确定优先级，生成任务 DAG，支持多 agent 并行开发。包含检查点机制和动态任务调整。当用户提到项目规划、任务拆解、开发计划、PRD 分析、模块依赖分析时触发。
---

# Task Planner

根据 PRD 和 Spec 文档，引导用户制定开发计划，生成任务 DAG，支持多 agent 并行执行。

## 工作流程

### 阶段 1：确认输入

1. 请用户提供 PRD 和 Spec 文件路径
2. 读取并快速概览文档，确认理解正确
3. 向用户总结文档核心内容，确认无误

### 阶段 2：模块识别

1. 从文档中识别主要功能模块
2. 列出模块清单，向用户确认：
   - 模块划分是否合理
   - 是否有遗漏或需要合并的模块

### 阶段 3：依赖分析

1. 分析模块间的依赖关系
2. 绘制初步依赖图，向用户确认：
   - 依赖关系是否正确
   - 是否有隐藏的依赖未被识别

### 阶段 4：任务拆解

1. 将每个模块拆解为具体可执行的任务
2. 任务粒度标准：

| 粒度 | 代码量 | 文件数 | 示例 |
|------|--------|--------|------|
| 小 | < 50 行 | 1 | 创建单个组件 |
| 中 | 50-200 行 | 2-3 | 实现一个 API 模块 |
| 大（应拆分） | > 200 行 | > 3 | 整个认证系统 |

3. 向用户确认任务粒度是否合适

### 阶段 5：优先级排序

1. 综合考虑因素：
   - 技术依赖（被依赖多的优先）
   - 业务价值（核心功能优先）
   - 风险程度（高风险早验证）
2. 向用户确认优先级排序

### 阶段 6：生成计划

1. 运行 DAG 验证脚本确保无循环依赖
2. 生成最终任务文档
3. 保存到项目目录

## 输出文档格式

```markdown
# [项目名称] 开发任务计划

## 元信息
- **PRD**: [文件路径]
- **Spec**: [文件路径]
- **生成时间**: YYYY-MM-DD HH:MM
- **任务总数**: N

## 任务依赖图

### Mermaid 视图
​```mermaid
graph TD
    TASK-001 --> TASK-003
    TASK-002 --> TASK-003
​```

### 依赖列表
- TASK-001: 无依赖
- TASK-002: 无依赖
- TASK-003: 依赖 [TASK-001, TASK-002]

## 任务列表

### TASK-001: [任务名称]
- **状态**: pending
- **执行者**: -
- **认领时间**: -
- **优先级**: P0
- **依赖**: 无
- **模块**: [所属模块]
- **描述**: [具体做什么]
- **验收标准**: [怎样算完成]
- **相关文件**: [预计涉及的文件]
```

## Agent 协作机制

### 会话标识

Agent 认领任务时自动生成会话 ID：
```
session-{YYYYMMDD}-{HHMMSS}-{随机3字符}
```

### 认领流程（使用脚本）

```bash
# 1. 查看可执行任务
python scripts/next_task.py TASKS.md

# 2. 认领任务（自动生成会话ID，更新状态）
python scripts/claim_task.py TASKS.md TASK-001

# 3. 执行任务...

# 4. 完成任务
python scripts/complete_task.py TASKS.md TASK-001

# 如果失败
python scripts/complete_task.py TASKS.md TASK-001 --failed

# 重置任务（重新执行）
python scripts/reset_task.py TASKS.md TASK-001
```

### 状态说明

| 状态 | 含义 |
|------|------|
| `pending` | 待执行 |
| `in_progress` | 执行中 |
| `completed` | 已完成 |
| `failed` | 执行失败 |

## 检查点机制

**每轮并行执行结束后，必须执行检查点：**

```bash
python scripts/checkpoint.py TASKS.md <项目根目录>
```

检查点会验证：
1. **产出物检查** — 验证相关文件是否已创建
2. **代码检查** — 检查 TypeScript 编译错误
3. **任务状态** — 统计进度，检测阻塞
4. **调整建议** — 建议是否需要插入修复任务或调整优先级

### 检查点报告示例

```
============================================================
检查点报告
============================================================

📊 进度统计
  总任务数: 20
  已完成: 15 (75.0%)
  进行中: 0
  失败: 1
  待执行: 4

📁 产出物检查
  ⚠️ 以下文件未找到:
    - TASK-008: backend/src/controllers/task.ts

🔍 代码检查
  ⚠️ 发现 lint 错误:
    [backend]
      src/controllers/task.ts(15,5): error TS2304...

💡 调整建议
  [blocked] 任务 TASK-008 失败，以下任务被阻塞: TASK-009, TASK-010
    → 请先修复 TASK-008，或调整依赖关系

🚀 下一步
  1. 处理 1 个失败任务
  2. 运行 next_task.py 查看可执行任务
============================================================
```

## 动态任务调整

### 插入修复任务

当任务失败时，插入修复任务：

```bash
python scripts/replan.py TASKS.md --insert-fix TASK-008 "修复 task 控制器的类型错误"
```

这会：
1. 创建新任务 TASK-021（或下一个可用 ID）
2. 将 TASK-008 重置为 pending
3. 让 TASK-008 依赖新的修复任务

### 重新评估优先级

根据当前执行情况重新计算优先级：

```bash
python scripts/replan.py TASKS.md --reprioritize
```

规则：被依赖次数越多，优先级越高。

### 获取调整建议

```bash
python scripts/replan.py TASKS.md --suggest
```

## 并行执行流程

**完整的并行开发循环：**

```
┌─────────────────────────────────────────────────────────┐
│  1. 查看可执行任务                                        │
│     python scripts/next_task.py TASKS.md                │
└─────────────────────┬───────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────┐
│  2. 认领任务（最多 4 个并行）                              │
│     python scripts/claim_task.py TASKS.md TASK-XXX      │
└─────────────────────┬───────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────┐
│  3. 并行执行任务                                          │
│     启动多个 Task agent                                   │
└─────────────────────┬───────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────┐
│  4. 完成任务                                              │
│     python scripts/complete_task.py TASKS.md TASK-XXX   │
└─────────────────────┬───────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────┐
│  5. 执行检查点 ⭐                                         │
│     python scripts/checkpoint.py TASKS.md <项目目录>     │
└─────────────────────┬───────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────┐
│  6. 根据检查点结果决定                                    │
│     - 有失败任务 → 插入修复任务，调整计划                  │
│     - 全部成功 → 返回步骤 1，继续下一轮                    │
│     - 所有完成 → 结束                                     │
└─────────────────────────────────────────────────────────┘
```

## 辅助脚本一览

| 脚本 | 功能 |
|------|------|
| `validate_dag.py` | 验证 DAG 无循环依赖 |
| `next_task.py` | 获取可执行任务列表 |
| `claim_task.py` | 认领任务（自动生成会话ID） |
| `complete_task.py` | 标记任务完成/失败 |
| `reset_task.py` | 重置任务为 pending |
| `checkpoint.py` | 执行检查点，验证产出 |
| `replan.py` | 动态调整任务（插入修复、重排优先级） |

## 注意事项

1. **每轮执行后必须运行 checkpoint** — 及时发现问题
2. **失败任务优先处理** — 避免阻塞后续任务
3. **最多 4 个 agent 并行** — 系统限制
4. **任务认领先到先得** — 通过脚本确保状态一致
5. **保持任务粒度适中** — 过大需拆分，过小可合并
